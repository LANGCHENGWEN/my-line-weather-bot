# handlers/default.py
"""
é€™å€‹æª”æ¡ˆæ˜¯è¨Šæ¯è·¯ç”±å™¨çš„æœ€å¾Œä¸€é“é˜²ç·šï¼Œä¸»è¦è² è²¬è™•ç†æ‰€æœ‰æœªè¢«å…¶ä»–ç‰¹å®šè¦å‰‡ï¼ˆä¾‹å¦‚æŒ‡ä»¤ã€ç‹€æ…‹è™•ç†å‡½å¼ï¼‰åŒ¹é…åˆ°çš„æ–‡å­—è¨Šæ¯ã€‚
å®ƒçš„ä¸»è¦è·è²¬æ˜¯å›è¦†é€šç”¨çš„å•å€™èªã€æ„Ÿè¬èªï¼Œä»¥åŠé‡å°ç„¡æ³•è­˜åˆ¥çš„è¨Šæ¯æä¾›ä¸€å€‹å‹å–„çš„ã€Œä¸æ˜ç™½ã€å›è¦†ï¼Œä»¥é¿å…è¨Šæ¯æ²’æœ‰ä»»ä½•å›æ‡‰ã€‚
é€™å€‹æ©Ÿåˆ¶ç¢ºä¿äº†ç„¡è«–ç”¨æˆ¶è¼¸å…¥ä»€éº¼ï¼Œéƒ½èƒ½å¾—åˆ°ä¸€å€‹åŸºæœ¬çš„ã€ä¸æœƒè®“å°è©±ä¸­æ–·çš„å›æ‡‰ã€‚
"""
import logging
from linebot.v3.messaging.models import TextMessage

from utils.api_helper import get_messaging_api
from utils.line_common_messaging import send_line_reply_message

logger = logging.getLogger(__name__)

def handle(event):
    """
    é€™æ˜¯é è¨­çš„è¨Šæ¯è™•ç†å‡½å¼ï¼Œæœƒè™•ç†æ‰€æœ‰æœªè¢« text_router.py å…¶ä»–è¦å‰‡åŒ¹é…åˆ°çš„æ–‡å­—è¨Šæ¯ã€‚
    å‡½å¼æœƒæ ¹æ“šè¨Šæ¯å…§å®¹ï¼Œåˆ¤æ–·æ˜¯å•å€™èªã€æ„Ÿè¬èªï¼Œæˆ–æ˜¯ä¸æ˜çš„è¨Šæ¯ï¼Œä¸¦çµ¦äºˆå°æ‡‰çš„å›è¦†ã€‚
    """
    api = get_messaging_api()
    text = event.message.text
    reply_token = event.reply_token
    user_id = event.source.user_id

    logger.info(f"[DefaultHandler] è™•ç†é€šç”¨/æœªè­˜åˆ¥è¨Šæ¯ä¾†è‡ªç”¨æˆ¶ {user_id}: '{text}'")

    # --- è™•ç†å•å€™èª ---
    # åµæ¸¬ç”¨æˆ¶æ˜¯å¦è¼¸å…¥äº†é€šç”¨çš„å•å€™èªï¼Œä¾‹å¦‚ã€Œä½ å¥½ã€æˆ–ã€Œå“ˆå›‰ã€
    if "ä½ å¥½" in text or "å“ˆå›‰" in text:
        messages = [
            TextMessage(text="ğŸ¤—å“ˆå›‰ï¼æ‚¨å¥½ï½æˆ‘æ˜¯æš–å¿ƒå¤©æ°£èª"),
            TextMessage(text="æ‚¨å¯ä»¥å…ˆè¨­å®šé è¨­åŸå¸‚ï¼Œç„¶å¾Œé»æ“Šé¸å–®ï¼Œæˆ‘æœƒå‘Šè¨´æ‚¨å¤©æ°£è³‡è¨Šå’Œç©¿æ­å»ºè­°å–”ï¼")
        ]
        send_line_reply_message(api, reply_token, messages)
        logger.info(f"[DefaultHandler] å·²å›è¦†å•å€™èªçµ¦ç”¨æˆ¶ {user_id}ã€‚")
        return True # è¡¨ç¤ºè¨Šæ¯å·²æˆåŠŸè™•ç†ï¼Œé˜»æ­¢è¨Šæ¯è·¯ç”±å™¨ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„è™•ç†å‡½å¼

    # --- è™•ç†æ„Ÿè¬èª ---
    # åµæ¸¬ç”¨æˆ¶æ˜¯å¦è¼¸å…¥äº†æ„Ÿè¬èªï¼Œä¾‹å¦‚ã€Œè¬è¬ã€
    elif "è¬è¬" in text:
        send_line_reply_message(api, reply_token, [TextMessage(text="ä¸å®¢æ°£ï¼å¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ ï½ğŸ™")])
        logger.info(f"[DefaultHandler] å·²å›è¦†æ„Ÿè¬èªçµ¦ç”¨æˆ¶ {user_id}ã€‚")
        return True # è¡¨ç¤ºè¨Šæ¯å·²æˆåŠŸè™•ç†ï¼Œé˜»æ­¢è¨Šæ¯è·¯ç”±å™¨ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„è™•ç†å‡½å¼

    # --- è™•ç†æ‰€æœ‰æœªåŒ¹é…çš„è¨Šæ¯ ---
    # æ•æ‰æ‰€æœ‰ä¸ç¬¦åˆä¸Šè¿°å•å€™èªæˆ–æ„Ÿè¬èªçš„æ–‡å­—è¨Šæ¯ï¼Œå›è¦†ä¸€å€‹é€šç”¨çš„ã€Œä¸æ˜ç™½ã€è¨Šæ¯
    else:
        messages = [
            TextMessage(text="æŠ±æ­‰ï¼Œæˆ‘ä¸æ˜ç™½æ‚¨çš„æ„æ€ğŸ¤”ã€‚è«‹å˜—è©¦é»æ“Šé¸å–®æˆ–è¼¸å…¥ç‰¹å®šé—œéµå­—ã€‚")
        ]
        send_line_reply_message(api, reply_token, messages)
        logger.info(f"[DefaultHandler] å·²å›è¦†ä¸æ˜ç™½è¨Šæ¯çµ¦ç”¨æˆ¶ {user_id}: '{text}'ã€‚")
        return True # è¡¨ç¤ºè¨Šæ¯å·²æˆåŠŸè™•ç†ï¼Œé˜»æ­¢è¨Šæ¯è·¯ç”±å™¨ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„è™•ç†å‡½å¼